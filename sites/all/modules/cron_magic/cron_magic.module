<?php
// $Id$
function cron_magic_perm()
{
	return array("Cron Magic");
}
function cron_magic_menu()
{
	$items = array();
	$items['admin/settings/cron_magic'] = array(
	'title' => 'Cron Magic',
	'description' => 'Index entire site in one go!!',
	'page callback' => 'help_text_testd_cron_magic',
	'access arguments' => array('administer site configuration'),
	);
	$items['admin/settings/cron_magic/help'] = array(
	'title' => 'Help',
	'description' => 'Index entire site in one go!!',
	'page callback' => 'help_text_testd_cron_magic',
	'access callback' => user_access,
	'access arguments' => array('administer site configuration'),
	'type' => MENU_LOCAL_TASK,
	);
	$items['admin/settings/cron_magic/list'] = array(
	'title' => 'Index entire site in one go!!',
	'page callback' => 'cron_magic_museum',
	'access callback' => user_access,
	'access arguments' => array('administer site configuration'),
	'type' => MENU_LOCAL_TASK,
	);
	return $items;
}

function help_text_testd_cron_magic()
{
	return  (which_return_help_textd_magic());
}



function which_return_help_textd_magic()
{


      if (variable_get('apachesolr_read_only', APACHESOLR_READ_WRITE) == APACHESOLR_READ_ONLY) {
        return t('Operating in read-only mode; updates are disabled.');
      }
      $remaining = 0;
      $total = 0;
      // Collect the stats
      $status = apachesolr_index_status('apachesolr_search');
      $remaining += $status['remaining'];
      $total += $status['total'];

      return t('The search index is generated by !cron. %percentage of the site content has been sent to the server. There @items left to send.', array(
        '!cron' => l(t('running cron'), 'admin/reports/status/run-cron', array('query' => array('destination' => 'admin/settings/apachesolr/index'))),
        '%percentage' => ((int)min(100, 100 * ($total - $remaining) / max(1, $total))) .'%',
        '@items' => format_plural($remaining, t('is 1 item'), t('are @count items')
      )));
}


function cron_magic_museum()
{
	

	
	return drupal_get_form('cron_magic_form');
}
function cron_magic_form()
{
	$form = array();
	$form['submit'] = array(
	'#type' => "submit",
	'#value' => t('Click to index all site in one go!!'),
	);
	return $form;
}

function cron_magic_form_submit(&$form,&$form_state)
{
	$function = 'cron_magic_batch_1';
	$batch = $function();
	batch_set($batch);
}


function cron_magic_batch_1() {
	//$result = db_query("SELECT count(nid) FROM  `content_type_artifact` WHERE  `field_artifact_institution_nid` = 42187");
//	$result = db_query("SELECT count(nid) FROM  node WHERE nid > 71446");
//	$cnt = db_result($result);

     if (variable_get('apachesolr_read_only', APACHESOLR_READ_WRITE) == APACHESOLR_READ_ONLY) {
        return t('Operating in read-only mode; updates are disabled.');
      }
      $remaining = 0;
      $total = 0;
      // Collect the stats
      $status = apachesolr_index_status('apachesolr_search');
      $remaining += $status['remaining'];
      $total += $status['total'];

	 $varRem = $remaining / 200;

	$operations = array();
	for ($i = 0; $i< $varRem; $i++) {
		 $operations[] = array('logic_for_cron_magic', array($i));
	}
	$batch = array(
		'operations' => $operations,
		'finished' => 'cron_magic_finished',
	
	  );
	  return $batch;
}


//function logic_for_cron_magic()
function logic_for_cron_magic($i,&$context)
{

/*$sqlDetete = "SELECT * FROM  node WHERE nid > 71446 LIMIT ".$i.",1";
$executeDeleteQuery = db_query($sqlDetete);
$nid = db_fetch_array($executeDeleteQuery);
*/
//node_delete($nid['nid']);
drupal_cron_run();

     if (variable_get('apachesolr_read_only', APACHESOLR_READ_WRITE) == APACHESOLR_READ_ONLY) {
        return t('Operating in read-only mode; updates are disabled.');
      }
      $remaining = 0;
      $total = 0;
      // Collect the stats
      $status = apachesolr_index_status('apachesolr_search');
      $remaining += $status['remaining'];
      $total += $status['total'];

/*$context['results'][] = "Status" . ' : ' . 'Cron ran successfully ';*/
//$context['results'][] = "Sql" . ' : ' . $sql;
$context['message'] = t('Loading @title', array('@title' => "Number of node remaing to be indexed " . ' : ' .$remaining ." out of ". $total));	
}

function cron_magic_finished($success, $results, $operations) {
  if ($success) {
    // Here we do something meaningful with the results.
    $message = count($results) .' processed.';
    $message .= theme('item_list', $results);
  }
  else {
    // An error occurred.
    // $operations contains the operations that remained unprocessed.
    //$error_operation = reset($operations);
    $message = t('An error occurred while processing %error_operation with arguments: @arguments', array('%error_operation' => $error_operation[0], '@arguments' => print_r($error_operation[1], TRUE)));
  $error_operation = reset($operations);
  }
  
  drupal_set_message($message);
}